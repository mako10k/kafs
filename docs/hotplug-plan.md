# KAFS ホットプラグ 大方針

最終更新: 2026-02-07

関連ドキュメント
- hotplug-requirements.md
- hotplug-design.md
- hotplug-pipe-plan.md
- hotplug-pipe-design.md

注記
- 現行実装は socketpair (AF_UNIX) で前後段を接続し、前段が後段を fork/exec する。
- UDS 前提の記述は過去設計として残している。詳細は hotplug-pipe-*.md を参照。

## 目的

- FUSE セッションを維持したまま、ユーザランド実装の差し替えを可能にする。
- 画像ファイルの差し替えは前段の再起動で完結させ、後段の再接続で継続運用する。
- 後段はロジックに集中し、ブロック I/O は前段に集約する。

## 前提と制約

- カーネルの FUSE セッションは 1 つの常駐プロセスに束縛される。
- マウント中に画像ファイルを差し替える運用は安全性が低く、原則非対応とする。
- RPC 断線時は一定時間ブロックし、再接続できなければ EIO を返す。

## 全体像

KERNEL
  | [FUSE]
FUSE-FRONT (常駐, BlockIO 担当, 再接続管理)
  | [socketpair RPC]
KAFS-BACK (ロジック特化, 交換可能)

前段が I/O を保持することで、後段の差し替えは「再接続」と「状態再構築」のみに限定される。

## 役割分担

前段 (FUSE-FRONT)
- /dev/fuse を保持し、FUSE オペレーションを受ける。
- 画像ファイルの open/mmap/journal/HRL など物理 I/O を担当する。
- open ハンドル、再送制御、タイムアウトを保持する。

後段 (KAFS-BACK)
- inode/dirent/権限/パス解決などロジックを担当する。
- 物理 I/O は行わず、前段に対する操作計画を返す。
- 再起動時は前段からの再構築要求で状態を再構成する。

## 非目標

- カーネル FUSE セッションのホットスワップ。
- マウント中の画像ファイル差し替え（前段が必須のため非対象）。
- 低レベル FUSE パケット中継の完全互換。

## フェーズ計画

Phase 0: ドキュメント整備
- 大方針、要件、設計の文書化。

Phase 1: 骨格分離
- 前段/後段のプロセス分割と UDS ルート確立。
- FUSE 前段が単独で起動できること。

Phase 2: RPC 基本機能
- getattr/read/write/truncate 等の必須オペレーションを RPC 化。
- 断線時ブロックとタイムアウト。

Phase 3: 再接続
- セッション再構築 (open ハンドルの再提示、再送抑止)。
- 冪等性保証 (req_id で重複排除)。

Phase 4: 拡張
- rename, readdir, ioctl, copy_file_range などの対応。
- 監視、統計、テストの拡充。

## 主要リスク

- RPC 境界の設計不備による性能低下。
- 断線復旧時の重複適用。
- 前段の状態肥大化。

## 成功基準

- 後段を再起動してもマウントは維持される。
- 再接続後に read/write が復旧し、整合性が保たれる。
- 断線時に最大待機時間を超えた I/O が明示的に失敗する。
