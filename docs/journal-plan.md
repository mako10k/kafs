# ジャーナル機能 拡張計画

最小実装としてのジャーナルは「イメージ内リングへのBEGIN/COMMIT/ABORT/NOTE記録（COMMITまでfsync）」と「起動時スキャン/クリーンアップ（任意コールバック）」まで実装済み。本計画では耐久性・性能・運用性を段階的に高める。

## 目的・ゴール
- クラッシュ後のリカバリでメタデータ整合性を担保（コミット済み操作の冪等再適用）
- 高スループット下でも安定（グループコミット・リング運用最適化）
- 観測/運用容易（ダンプツール、メトリクス、設定項目）

成功基準（Definition of Done）
- クラッシュ/再マウント後にメタデータ一貫性が保たれる（整合性テストPASS）
- ジャーナルサイズとポリシーが設定可能で、負荷下でもスループットが退化しない
- ダンプ/クリアツールで内容と状態を確認・操作できる

## 現状（2025-08-28）
- イメージ内ジャーナル: 固定長リング（ヘッダ: area_size, write_off, seq）
- レコード: BEG/CMT/ABR/NOTE（テキストpayload）
- リプレイ: コミット済みの抽出とクリーンアップ（既定は実再適用なし、CBで拡張可能）
- mkfs: ジャーナルサイズ指定（-J/--journal-size-bytes）

## マイルストーン

### M1: 安全性と性能の底上げ（最短）
- レコードCRC32（ヘッダ含む）導入、ヘッダにもCRC追加（ねじれ/破損検出）
- fsync最適化: COMMITでのみfdatasync、BEGIN/NOTE/ABORTはバッファリング
- 簡易ダンプ `kafs-journalctl`（ヘッダ/レコード一覧）と `kafs-journal-clear`（安全クリア）

### M2: 既定リプレイの実装（冪等）
- payloadをTLV構造へ（op=enum, path, mode, uid, gid, target, …）
- FUSE非依存な内部メタ操作APIの切り出し（create/dirent_add/unlink/chmod/chown/symlink）
- 既定コールバックでCOMMIT済みの再適用を自動実行（冪等・ロック順序固定）
- リプレイ完了でヘッダに“クリーン”フラグ立て＆リング初期化

### M3: 容量制御と観測性
- tail（読取）ポインタ追加：未リプレイ領域の上書き防止
- ポリシー: drop_oldest=on|off / backpressure（書込みブロック）を設定化
- メトリクス出力: 占有率, 書込バイト, fsync回数, 未コミット数

### M4: スキャン高速化と外部統一
- WRAP世代カウンタ導入（フェンス）でO(n)→O(k)スキャンへ
- サイドカージャーナルもバイナリ形式へ統一（解析/ツール共有）

## 具体タスク（チェックリスト）

- フォーマット/互換
  - [ ] ヘッダ: version++、crc32, flags, tail_off, cleanフラグ追加
  - [ ] レコード: {tag,size,seq,crc} + TLV payload
  - [ ] 旧形式→新形式マイグレーション/自動初期化

- 書込みパス
  - [ ] BEGIN/NOTE/ABORTはバッファリング、COMMITでまとめて`fdatasync`
  - [ ] グループコミット（短時間内のCOMMITを集約、設定で調整）

- リプレイ
  - [ ] TLVパーサ
  - [ ] 内部メタAPI（FUSE文脈非依存）
  - [ ] 既定コールバックで冪等再適用（CREATE/MKDIR/UNLINK/CHMOD/CHOWN/SYMLINK）
  - [ ] クリーンフラグ管理とリング初期化

- 容量/ポリシー
  - [ ] tailポインタ導入と上書き制御
  - [ ] `drop_oldest` と `backpressure` の実装・設定化

- 観測/運用
  - [ ] `kafs-journalctl`（一覧/ヘッダ表示/CRC検証）
  - [ ] `kafs-journal-clear`（安全に初期化）
  - [ ] メトリクス: ログ/統計エンドポイント（デバッグログで可）

- 設定
  - [ ] 環境変数/マウントオプション: fsync=always|commit, replay=on|dry-run, drop_oldest=on|off
  - [ ] mkfs: ジャーナルサイズの整列（4096B）と最小/最大チェック

## API/互換性
- `kafs_journal.h`
  - [ ] 新ヘッダ・レコード定義、CRC関数、グループコミット制御
  - [ ] `kafs_journal_replay(cb)` 既定CBの実装/公開
- 内部メタAPI（新規）
  - [ ] `kafs_meta_create/mkdir/unlink/chmod/chown/symlink`（冪等、ロック順序固定）
- 互換性指針
  - 新形式が優先。旧形式検出時は初期化か、読み捨てクリアで移行

## テスト計画
- フォールトインジェクション
  - SIGKILL/電源断相当 → 再マウント → 整合性検証
- 破損耐性
  - ヘッダ/レコードCRC不一致でのスキップ範囲最小化
- 並行性/性能
  - 多スレッド大量トランザクション、fsync集約の有無で比較
- ツール
  - `kafs-journalctl` 出力の正しさ/回帰

## リスクと対策
- リプレイの誤適用 → TLV化/冪等設計/包括テストで抑制
- パフォーマンス劣化 → グループコミット/非同期fsync/計測と閾値調整
- 互換性 → バージョン/フラグ/自動初期化ガード

## ロールアウト
- M1→M2→M3→M4 の順で小さく出荷、各段でストレス/整合性テストPASSをゲート
- 既知過去イメージは再マウント時に新形式へ初期化（または明示オプション）

---
更新履歴
- 2025-08-28: 初版（計画作成）
