# KAFS ホットプラグ 要件

最終更新: 2026-02-07

関連ドキュメント
- hotplug-plan.md
- hotplug-design.md
- hotplug-ipc-plan.md
- hotplug-ipc-design.md

注記
- 現行実装は socketpair (AF_UNIX) で前後段を接続し、前段が後段を fork/exec する。
- IPC は socketpair のみを使用する。UDS 依存は廃止・削除対象。

## 1. 機能要件

1. FUSE セッションは前段で常時保持されること。
2. 後段のプロセスは停止/再起動/差し替えが可能であること。
3. 前段は後段の再接続を検知し、一定時間ブロックして待機できること。
4. ブロック I/O は前段に集約され、後段は物理 I/O を行わないこと。
5. 後段は論理操作の決定を返し、前段が実行できること。
6. 再接続後に open ハンドルが再提示され、必要な状態が再構築されること。
7. req_id により冪等性が確保されること。
8. 断線時に I/O がタイムアウトで失敗すること (EIO)。
9. RPC が利用不能でも前段はカーネルからの要求を受け続けること。
10. 断線待機時間は設定可能であること (例: 5s-60s)。
11. 画像ファイルの差し替えは非対象 (前段必須のため)。
12. 断線中に新規マウント要求や umount 要求があっても前段は応答できること。
13. READ/WRITE のデータ経路は「RPC に載せる」か「計画のみ返す」を選択可能にすること。
14. COPY 相当の操作を RPC に用意できること。

## 2. 非機能要件

- レイテンシ: 追加オーバーヘッドは通常時 2 倍以内を目標。
- 可用性: 後段の単独再起動で復旧可能。
- 観測性: 再接続回数、待機時間、失敗数を記録する。
- 互換性: 既存 KAFS の動作仕様を原則維持する。
- 運用性: 断線待機時間、再試行回数、最大待機キュー長を設定可能にする。
- 拡張性: 前段は他の FUSE システムでも流用可能な抽象化とする。

## 3. 整合性・安全性

- 書き込みは前段の I/O 完了をもって成功とする。
- 後段の再起動中は I/O をブロックし、タイムアウトで失敗する。
- req_id の重複適用を防止し、二重書き込みを回避する。
- タイムアウト後に後段が復旧しても、当該リクエストは再送しない。

## 4. セッション要件

- 前段は session_id と epoch を持ち、後段に通知する。
- 後段は epoch 不一致のリクエストを拒否する。
- 再接続時に open ハンドル一覧を前段が通知する。
- open ハンドルは前段で一意に管理し、再接続時に再提示する。

## 5. RPC 要件

- socketpair (AF_UNIX) を使用し、同一ホスト内通信とする。
- UDS フォールバックは行わない。
- リクエスト/レスポンスは明示的なサイズと req_id を持つ。
- エラーは -errno をそのまま返す。
- read/write の payload は RPC に含めるか、共有メモリ方式を将来拡張できること。
- READ/WRITE のデータ経路は運用で切り替え可能にすること。

## 6. セキュリティ

- 前段が uid/gid/pid を付与し、後段は入力として扱う。

## 7. 拡張性要件

1. 前段は KAFS に依存しない共通インタフェースで構成すること。
2. `kafsctl` で後段の再起動、再接続確認、状態取得ができること。
3. 前段-後段のバージョン互換性を確認し、非互換の場合は警告または再起動キャンセルが可能なこと。
4. 再起動時に利用する環境変数を参照・更新できること。

## 8. テスト要件

- 後段の再起動中に read/write を発行し、復旧後に成功すること。
- タイムアウトで失敗する I/O の挙動が一定であること。
- req_id の重複送信に対し一度だけ適用されること。
- 断線中の待機キューが上限を超えた場合に即時エラーとなること。
